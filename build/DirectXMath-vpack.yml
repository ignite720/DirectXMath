# Copyright(c) Microsoft Corporation. All rights reserved.
#
# http://go.microsoft.com/fwlink/?LinkID=615560

# Builds and submit the DirectXMath vpack to Microsoft Collections Artifacts for the OS.

variables:
  VPACK_PAT: $(VPackPAT)
  BUILD_PAT: $(BuildToken)
  USER_PAT: $(UserToken)

resources:
  repositories:
  - repository: self
    type: git
    ref: refs/heads/ms_sdk_release
    trigger:
      branches:
        include:
          - ms_sdk_release
        exclude:
          - main

  - repository: templates_onebranch
    type: git
    name: OneBranch.Pipelines/GovernedTemplates
    ref: refs/heads/main

pool:
    name: GDKDevToolsMSCodeHubPool
    demands: DotNetFramework

jobs:
- job: VPACK_BUILD
  displayName: 'Build and publish vpack'
  cancelTimeoutInMinutes: 1
  workspace:
    clean: outputs
  steps:
  - checkout: self
    path: 's'

  - task: PkgESSetupBuild@12
    displayName: Package ES - Setup Build
    inputs:
      disableWorkspace: true

  - task: NodeTool@0
    displayName: NPM install
    inputs:
      versionSpec: '14.x'

  - task: CopyFiles@2
    inputs:
      SourceFolder: '$(BUILD.SOURCESDIRECTORY)\Inc'
      Contents: '**'
      TargetFolder: '$(BUILD.BINARIESDIRECTORY)\vpack'
      CleanTargetFolder: true

  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: 'Get-ChildItem -Path *.h,*.inl | %{ Rename-Item -Path $_ -NewName ("$($_.BaseName)p$($_.Extension)").ToLower() }'
      workingDirectory: '$(BUILD.BINARIESDIRECTORY)\vpack'

  - task: CopyFiles@2
    inputs:
      SourceFolder: '$(BUILD.SOURCESDIRECTORY)'
      Contents: |
        README.md
        LICENSE
      TargetFolder: '$(BUILD.BINARIESDIRECTORY)\vpack'

  - template: v2/Steps/PackageES/Windows.SDL.Sources.Analysis.OS.Undocked.yml@templates_onebranch
    parameters:
        globalsdl:
            codeql:
                tsandjs:
                  enabled: false
                python:
                  enabled: false
                psscriptanalyzer:
                  enable: true
            prefast:
                enabled: true

  - template: v2/Steps/PackageES/Windows.SDL.Binary.Analysis.OS.Undocked.yml@templates_onebranch
    parameters:
        variables:
            ob_outputDirectory: '$(BUILD.BINARIESDIRECTORY)'

  - task: PkgESVPack@12
    inputs:
      vPackCmd: 'push'
      versionAs: 'parts'
      sourceDirectory: '$(BUILD.BINARIESDIRECTORY)\vpack'
      description: '$(Build.Repository.Name).$(Build.SourceBranchName)'
      pushPkgName: directxmath.oss
      owner: 'directxtkdev'
      configurations: 'release'
      platforms: 'any cpu'
      majorVer: '3'
      minorVer: '1'
      patchVer: '8'
      prereleaseVer: '$(Build.BuildId)'
      provData: true
      vpackToken: $(VPACK_PAT)

  - task: PublishPipelineArtifact@1
    displayName: 'Copy VPack Manifest to Drop'
    inputs:
      targetPath: $(XES_VPACKMANIFESTDIRECTORY)
      artifactName: directxmath.oss

  - task: PkgESFCIBGit@12
    displayName: 'Package ES - Submit Files to Git'
    inputs:
      configPath: 'build/GitCheckin.json'
      artifactsDirectory: $(XES_VPACKMANIFESTDIRECTORY)
      userToken: '$(USER_PAT)'
      prTimeOut: 5
      paToken: '$(BUILD_PAT)'
